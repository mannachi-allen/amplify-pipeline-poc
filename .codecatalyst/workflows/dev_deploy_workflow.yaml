Name: dev_deploy_workflow
SchemaVersion: '1.0'

Triggers:
  - Type: Push
    Branches:
      - dev

Actions:
  Setup_Dev:
    Identifier: aws/build@v1.0.0
    Inputs:
      Sources:
        - WorkflowSource
      Variables:
        - Name: REACTCONFIG
          Value: '{"SourceDir":"src","DistributionDir":"build","BuildCommand":"npm run-script build","StartCommand":"npm run-script start"}'
        - Name: AWSCLOUDFORMATIONCONFIG
          Value: '{"configLevel":"project","useProfile":false,"profileName":"default","accessKeyId":${Secrets.AWS_ACCESS_KEY},"secretAccessKey":${Secrets.AWS_SECRET_KEY},"region":"us-east-2"}'
    Outputs:
      Variables:
        - REACTCONFIG
        - AWSCLOUDFORMATIONCONFIG
    Configuration:
      Steps:
        - Run: echo $REACTCONFIG
        - Run: echo $AWSCLOUDFORMATIONCONFIG
    Compute:
      Type: Lambda
      Fleet: Linux.x86-64.Large
    Environment:
      Connections:
        - Role: CodeCatalystPreviewDevelopmentAdministrator-pm6byj
          Name: '948537597984'
      Name: Dev
  Build_Dev:
    Identifier: aws/build@v1.0.0
    Inputs:
      Sources:
        - WorkflowSource
      Variables:
        - Name: AMPLIFY
          Value: '{"projectName":"amplifypipelinepoc","envName":"dev","defaultEditor":"code"}'
        - Name: FRONTEND
          Value: '{"frontend":"javascript","framework":"react","config":${Setup_Dev.REACTCONFIG}}'
        - Name: PROVIDERS
          Value: '{"awscloudformation":${Setup_Dev.AWSCLOUDFORMATIONCONFIG}}'
    Outputs:
      AutoDiscoverReports:
        Enabled: true
        ReportNamePrefix: amplify-rpt
    Configuration:
      Steps:
        - Run: npm install -g @aws-amplify/cli
        - Run: npm install
        - Run: echo $AMPLIFY
        - Run: echo $FRONTEND
        - Run: echo $PROVIDERS
        - Run: amplify init --amplify '$AMPLIFY' --frontend '$FRONTEND' --providers '$PROVIDERS' --yes
        - Run: amplify push -y --allow-destructive-graphql-schema-updates
    Compute:
      Type: Lambda
      Fleet: Linux.x86-64.Large
    Environment:
      Connections:
        - Role: CodeCatalystPreviewDevelopmentAdministrator-pm6byj
          Name: '948537597984'
      Name: Dev
